# 更新说明

## 主要更新内容

### 1. 用户认证系统
- ✅ 添加了简约美观的登录/注册界面
- ✅ 用户数据存储在本地SQLite数据库 (`users.db`)
- ✅ 支持用户注册、登录和登出功能
- ✅ 使用Session管理用户登录状态

### 2. 题目可见范围功能
- ✅ 题目数据库增加了 `user_id`（上传用户）和 `visibility`（可见范围）字段
- ✅ 可见范围选项：
  - **所有人** (public): 所有用户可见
  - **仅自己** (private): 仅上传者可见
- ✅ 在"录入题目"和"试卷解析"页面都添加了可见范围选择器
- ✅ 搜索和预览功能只显示当前用户有权访问的题目

### 3. 状态栏
- ✅ 移除了原来固定的标题banner
- ✅ 添加了新的状态栏，显示：
  - 系统标题
  - 题目总量统计
  - 当前登录用户
  - 购物车图标（显示已选题目数量）
  - 登出按钮

### 4. 生成试卷功能（购物车）
- ✅ 在搜索结果和解析结果中每个题目旁边添加"加入试卷"按钮
- ✅ 状态栏购物车图标显示已选题目数量
- ✅ 点击购物车图标可打开生成试卷对话框
- ✅ 在对话框中可以：
  - 预览已选择的题目
  - 调整题目顺序（上移/下移）
  - 移除不需要的题目
  - 清空所有题目
- ✅ 导出选项：
  - **导出模式**: 仅试题 / 试题+解析答案
  - **导出格式**: LaTeX / Word (DOCX) / PDF
- ✅ 支持一键导出试卷文件

### 5. 界面优化
- ✅ 统一了搜索结果和题目预览的展示效果
- ✅ 修复了CSS中`.btn`的margin问题，按钮与文本现在正确对齐
- ✅ 移除了JS中未定义的事件处理函数（如`handleBatchTag`）
- ✅ 优化了响应式设计，支持移动端显示

## 技术更新

### 新增文件
- `user_manager.py`: 用户管理模块
- `templates/login.html`: 登录/注册页面
- `UPDATE_NOTES.md`: 本更新说明文档

### 修改文件
- `config.py`: 添加用户数据库路径和Session密钥配置
- `web_server.py`: 添加用户认证路由、权限验证、导出API
- `question_manager.py`: 更新数据库结构，添加用户和可见范围支持
- `templates/index.html`: 重新设计界面，添加状态栏和购物车功能
- `static/style.css`: 更新样式，添加状态栏和购物车样式，修复bugs
- `static/script.js`: 重写脚本，添加完整的用户认证和购物车功能
- `requirements.txt`: 添加新依赖（python-docx、reportlab）

### 新增依赖
```
python-docx==0.8.11  # 用于生成Word文档
reportlab==4.0.7     # 用于生成PDF文档
openai==1.3.0        # 已有，用于LLM API调用
```

## 使用说明

### 首次使用
1. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```

2. 启动服务器：
   ```bash
   python web_server.py
   ```

3. 访问 `http://127.0.0.1:5001/login` 注册新账户

### 主要功能使用

#### 录入题目
1. 登录后进入"录入题目"标签页
2. 输入题目内容（支持LaTeX格式）
3. 选择题目标签
4. **选择可见范围**（所有人/仅自己）
5. 可选：使用"自动打标和生成解答"功能
6. 点击"保存题目"

#### 试卷解析
1. 进入"试卷解析"标签页
2. **选择默认可见范围**
3. 上传试卷图片
4. 点击"开始解析"
5. 可以在解析结果中直接"加入试卷"
6. 或点击"批量保存到数据库"

#### 生成试卷
1. 在搜索结果或解析结果中点击"加入试卷"按钮
2. 点击状态栏的购物车图标
3. 调整题目顺序
4. 选择导出模式和格式
5. 点击"导出试卷"

## 数据库迁移

如果您有旧的题目数据库，系统会自动进行迁移：
- 自动添加 `user_id` 和 `visibility` 字段
- 旧题目默认设置为 `visibility='public'`（所有人可见）
- `user_id` 为空的旧题目对所有用户可见

## 注意事项

1. **首次运行**：会自动创建 `users.db` 数据库
2. **密码安全**：密码使用SHA256哈希存储
3. **Session密钥**：请在生产环境中修改 `config.py` 中的 `SECRET_KEY`
4. **导出文件**：导出的文件临时保存在 `uploads/` 目录
5. **数学公式**：LaTeX公式在导出为Word/PDF时会被简化处理

## 已知问题

1. PDF导出暂不支持完整的LaTeX数学公式渲染（使用简化处理）
2. 如需完整数学公式支持，建议使用LaTeX格式导出后自行编译

## 未来改进方向

- [ ] 支持团队/班级功能
- [ ] 题目标签的层级分类
- [ ] 试卷模板自定义
- [ ] 题目评论和讨论功能
- [ ] 导出时的更多格式选项
